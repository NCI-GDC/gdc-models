os: linux
dist: bionic
language: python
python:
  - "3.6"
  - "3.7"
  - "3.8"
  - "3.9"
  - "3.10"
  - "3.11-dev"

env:
  - ES_VERSION="7.7.1"

addons:
  apt:
    packages:
      - "python3-pip"
      - "python3-venv"

before_install:
  - sudo rm -rf /var/lib/elasticsearch
  - curl -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-${ES_VERSION}-amd64.deb
  - sudo dpkg -i --force-confnew elasticsearch-${ES_VERSION}-amd64.deb
  - sudo chown elasticsearch /etc/default/elasticsearch
  # Our ES mappings require the mapper-size plugin to be installed
  - sudo /usr/share/elasticsearch/bin/elasticsearch-plugin install mapper-size
  - sudo service elasticsearch restart

install:
  - /usr/bin/python3 -m pip install pipx --user
  - pipx install poetry
  - pipx inject poetry poetry-dynamic-versioning
  - pip install tox-travis tox-poetry

script:
  - tox

after_script:
  - tox -e coverage
  - bash <(curl -s -L https://detect.synopsys.com/detect.sh) --blackduck.url="https://cdis.blackducksoftware.com" --blackduck.api.token=$(echo $BLACKDUCK_TOKEN) --blackduck.trust.cert=true --detect.policy.check=true  --snippet-matching=true --full-snippet-scan=true

jobs:
  allow_failures:
    - python: "3.11-dev"
